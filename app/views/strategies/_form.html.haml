= form_with(model: strategy, scope: :strategy) do |form|
  - if strategy.errors.any?
    .alert.alert-danger
      %h5= "#{pluralize(strategy.errors.count, "error")} prohibited this strategy from being saved:"
      %ul
        - strategy.errors.each do |error|
          %li= error.full_message

  .card
    .card-body
      .row.mb-3
        .col-md-6
          .form-group
            = form.label :name, class: "required form-label"
            = form.text_field :name, class: "form-control", placeholder: "Enter strategy name", required: true
        .col-md-6
          .form-group
            - if strategy.new_record?
              = form.label :type, "Strategy Type", class: "required form-label"
              = form.select :type,
                            [["Instrument Based", "InstrumentBasedStrategy"], ["Rule Based", "RuleBasedStrategy"], ["Screener Based", "ScreenerBasedStrategy"]],
                            { prompt: "Select Strategy Type" },
                            { class: "form-control select2", id: "strategy_type", required: true }
            - else
              = form.label :type, "Strategy Type", class: "required form-label"
              = text_field_tag :type, strategy.type.titleize, class: "form-control", disabled: true

      #instrument_selection{style: strategy.is_a?(InstrumentBasedStrategy) ? "" : "display: none;"}
        .row.mb-3
          .col-md-12
            .form-group
              = form.label :master_instrument_ids, "Select Instruments", class: "form-label"
              = form.select :master_instrument_ids,
                            options_for_select(@master_instruments.map { |mi| [mi.name, mi.id] }, strategy.is_a?(InstrumentBasedStrategy) ? strategy.master_instrument_ids : []),
                            {},
                            { multiple: true, class: "form-control select2", id: "master_instrument_ids" }
              %small.form-text.text-muted Search and select multiple instruments
      #screener_selection{style: strategy.is_a?(ScreenerBasedStrategy) ? "" : "display: none;"}
        .row.mb-3
          .col-md-6
            .form-group
              = form.label :screener_id, "Select Screener", class: "form-label"
              = form.select :screener_id,
                            options_for_select(@screeners.map { |mi| [mi.name, mi.id] }, strategy.is_a?(ScreenerBasedStrategy) ? strategy.screener_id : nil),
                            {},
                            { multiple: false, class: "form-control select2", id: "screener_id" }
              %small.form-text.text-muted Search and select multiple screeners
          .col-md-6
            .form-group
              = form.label :screener_execution_time, "Screener Execution Time", class: "form-label"
              .d-flex.gap-2
                = form.time_field :screener_execution_time,
                                  class: "form-control",
                                  style: "width: auto;"
              %small.form-text.text-muted Select the time to run the screener

      .row.mb-3
        .col-md-6
          .form-group
            = form.label :entry_rule, class: "form-label"
            = form.text_area :entry_rule, class: "form-control", rows: 4, placeholder: "Enter strategy entry rule"
        .col-md-6
          .form-group
            = form.label :exit_rule, class: "form-label"
            = form.text_area :exit_rule, class: "form-control", rows: 4, placeholder: "Enter strategy exit rule"

      .row.mb-3
        .col-md-6
          .form-group
            = form.label :description, class: "form-label"
            = form.text_area :description, class: "form-control", rows: 2, placeholder: "Enter strategy description"

    .card-footer
      = form.submit :submit, class: "btn btn-primary"
      = link_to "Cancel", strategies_path, class: "btn btn-secondary ml-2"

:javascript
  function toggleStrategyFields() {
    const instrumentSelection = document.getElementById('instrument_selection');
    const screenerSelection = document.getElementById('screener_selection');

    $('#strategy_type').on('select2:select', function(e) {
      const selectedValue = e.params.data.id;

      if (selectedValue === 'InstrumentBasedStrategy') {
        if (screenerSelection) screenerSelection.style.display = 'none';
        if (instrumentSelection) instrumentSelection.style.display = 'block';
      } else if (selectedValue === 'ScreenerBasedStrategy') {
        if (instrumentSelection) instrumentSelection.style.display = 'none';
        if (screenerSelection) screenerSelection.style.display = 'block';
      } else {
        if (instrumentSelection) instrumentSelection.style.display = 'none';
        if (screenerSelection) screenerSelection.style.display = 'none';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    toggleStrategyFields();
  });

  document.addEventListener('turbo:load', function() {
    toggleStrategyFields();
  });
